---
title: "Final Project Initial Analysis"
author: "Scott Burstein"
date: "10/21/2020"
###"Data Science and Society (Sociology 367) - Final Project"
output: html_document
---

# Setup

## Configure RStudio Rmd File Output Format

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load the Libraries and Datasets

Kaggle Natural Disaster Dataset: 
https://www.kaggle.com/headsortails/us-natural-disaster-declarations

gtrendsR Package: 
https://cran.r-project.org/web/packages/gtrendsR/gtrendsR.pdf

```{r message=FALSE}

#---PACKAGES------  > remove "#" if package not previously installed
#install.packages("tidyverse")
library(tidyverse)
#install.packages("gtrendsR")
library(gtrendsR)
#install.packages("ggthemes")
library(ggthemes)
#install.packages("maps")
library(maps)

#---DATA---------
FEMA_Declarations <- read_csv("FEMA_data/us_disaster_declarations.csv")
view(FEMA_Declarations)
M5_Subset <- read_csv("FEMA_data/us_disasters_m5.csv")
view(M5_Subset)
```
<br/><br/>

# Filter for Event Types

### Generalizable Parameters for Event Filter

```{r params}
# Start year to filter events (only show FEMA decs. since specified year)
init_year <- 2015
```


## Florida Hurricanes since `init_year`

```{r FL_Hurricanes}
FL_Hurricanes <- FEMA_Declarations %>% 
  filter(incident_type == "Hurricane", incident_begin_date >= init_year, state == "FL") %>% 
  select(declaration_title) %>% 
  distinct()
  
FL_Hurricanes  
#sub(".*? ", "", FEMA_Declarations$declaration_title)
```
## California Wildfires since `init_year`

```{r CA_Fires}
CA_Fires <- FEMA_Declarations %>% 
  filter(incident_type == "Fire", incident_begin_date >= init_year, state == "CA") %>% 
  select(declaration_title) %>% 
  distinct()
  
CA_Fires  
```
# Research Questions



```{r gtrends_function}

list_of_weather_events<-c("camp fire","hurricane")

finaldata<-as.data.frame(NULL)
for (i in 1:length(list_of_weather_events)){
  weather_event_gtrends <- gtrends(keyword = list_of_weather_events[i],
                     geo = "US") #add date parameter time = "today 12-m" --> find date from original file of event.Use Lubridate
  all_states_interest <- as.data.frame(weather_event_gtrends[3])
  finaldata <- rbind(finaldata, all_states_interest)
  print(i)
  Sys.sleep(5)
}

finaldata


climate_change_trend <- gtrends(keyword = "climate change",
                   geo = "US" #change location
                   ) 

#climate_change_trend[1]$interest_over_time
```

```{r US_climate_change viz}

climate_search_terms <- c(
"climate change",		
"global warming",		
"fossil fuel",		
"green new deal"
)

climate_change_gtrends <- gtrends(keyword = climate_search_terms,
        geo = "US", #change to state?
        time = "today 12-m") 
#%>% summary()

climate_change_gtrends[1]$interest_over_time

US_climate_interest <- climate_change_gtrends %>% 
          .$interest_over_time %>% #not working
          glimpse()

 climate_change_facet_plot <- US_climate_interest %>% 
  mutate_at("hits", ~ifelse(. == "<1", 0.5, .)) %>% # replace with 0.5
  mutate_at("hits", ~as.numeric(.)) %>% # convert to numeric
  # Begin ggplot
  ggplot(aes(x = date, y = hits)) +
  #geom_vline(xintercept = 1.59e+09) + #determine key dates in correct format
  geom_line(colour = "darkblue", size = 1.5) +
  facet_wrap(~keyword) +
  ggthemes::theme_economist()
 #+ annotate()
climate_change_facet_plot
```

Resource Cited: 
https://martinctc.github.io/blog/vignette-google-trends-with-gtrendsr/

```{r}
search_terms <- c(
"Hurricane Michael",		
"Hurricane Dorian",		
"Hurricane Isaias",		
"Hurricane Sally"
)

output_results <- gtrends(keyword = search_terms,
        geo = "US", #change to FL
        time = "today 12-m") 
#%>% summary()

output_results[1]$interest_over_time


FL_hurr_interest <- output_results %>% 
          .$interest_over_time %>% #not working
          glimpse()
```

```{r FL_hurricane viz}
 FL_hurr_plot <- FL_hurr_interest %>% 
  mutate_at("hits", ~ifelse(. == "<1", 0.5, .)) %>% # replace with 0.5
  mutate_at("hits", ~as.numeric(.)) %>% # convert to numeric
  # Begin ggplot
  ggplot(aes(x = date, y = hits)) +
  geom_line(colour = "darkblue", size = 1.5) +
  facet_wrap(~keyword) +
  ggthemes::theme_economist()
#FL_hurr_plot
```

```{r}
CA__top4_fires <- c(
"Mendocino Complex",		
"August Fire",		
"Creek Fire",		
"North Complex"
)

CA_top_fire_trends <- gtrends(keyword = CA__top4_fires,
        geo = "US",
        time = "today 12-m") 
#%>% summary()


CA_fire_interest <- CA_top_fire_trends %>% 
          .$interest_over_time %>%
          glimpse()

#CA_fire_interest[1]$interest_over_time
```

```{r Generalizable plotting function}
plot.gtrends.silent <- function(x, ...) {
  df <- x$interest_over_time
  df$date <- as.Date(df$date)
  df$hits <- if(typeof(df$hits) == 'character'){
    as.numeric(gsub('<','',df$hits))
    } else {
    df$hits
    }
 
  df$legend <- paste(df$keyword, " (", df$geo, ")", sep = "")
 
  p <- ggplot(df, aes_string(x = "date", y = "hits", color = "legend")) +
    geom_line() +
    xlab("Date") +
    ylab("Search hits") +
    ggtitle("Interest over time") +
    theme_bw() +
    theme(legend.title = element_blank())
 
  invisible(p)
}
```

Resource Cited: 
https://davetang.org/muse/2018/12/31/visualising-google-trends-results-with-r/

```{r}

fire_and_climate_change_search_terms <- c(
  "fire",
  "climate change",
  "insurance"
)

CA_all_fire_trends <- gtrends(keyword = fire_and_climate_change_search_terms,
        geo = "CA") #time = "today+5-y" Last five years (default)


CA_fire_plot <- plot.gtrends.silent(CA_all_fire_trends)
 
CA_fire_plot +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  theme(legend.position = "bottom")
```

```{r}

indiv_fire_trend <- gtrends(keyword = "fire",
        geo = "CA") #time = "today+5-y" Last five years (default)

graph_trend <- indiv_fire_trend$interest_over_time

ggplot(data = graph_trend) + 
  aes(x = date, y = hits, color = keyword) + 
  geom_line() + 
  scale_colour_viridis_d(option  = "viridis") + 
  labs(title = "Interest by Date", 
       x = "Date", 
       y = "Relative Interest") + 
  #scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  theme_minimal() + 
  theme(legend.position = 'bottom')
```

Resource Cited:
http://rstudio-pubs-static.s3.amazonaws.com/520533_f25fa191afa7476a995322a4393710ce.html

```{r CA_fire viz}
 CA_fire_facet_plot <- CA_fire_interest %>% 
  mutate_at("hits", ~ifelse(. == "<1", 0.5, .)) %>% # replace with 0.5
  mutate_at("hits", ~as.numeric(.)) %>% # convert to numeric
  # Begin ggplot
  ggplot(aes(x = date, y = hits)) +
  geom_line(colour = "dark red", size = 1.5) +
  facet_wrap(~keyword) +
  ggthemes::theme_economist()
CA_fire_facet_plot
```

```{r state_date declaration count}

FEMA_Declarations <- FEMA_Declarations %>% 
  mutate(declaration_day = gsub( " .*$", "", declaration_date ))

state_date_FEMA_decs <- FEMA_Declarations %>% 
  group_by(state, declaration_day) %>% 
  count()

#state_date_FEMA_decs
```
```{r state declarations count since date}

date_since <- 2000-01-01 # January 1st, 2000

state_FEMA_decs_total <- state_date_FEMA_decs %>%
  filter(declaration_day >= date_since) %>% 
  group_by(state) %>% 
  count() %>% 
  arrange(desc(n))

state_FEMA_decs_total
```
Since January 1st, 2000, the following 10 states have had the most FEMA 
natural disaster emergency declarations called:

CA, TX, OK, WA, FL, OR, NM, NV, AZ, CO

### Data set for climate change Google searches by day:

```{r}
search_terms <- c(
"climate change"
)

climate_trends <- gtrends(keyword = search_terms,
        geo = "US", #change to FL
        time = "today 12-m")

location_df <- data.frame(climate_trends[["interest_by_region"]][["location"]])
hits_df <- data.frame(climate_trends[["interest_by_region"]][["hits"]])

names(location_df) <- "location"
names(hits_df) <- "hits"

climate_location_hits_table <- cbind(location_df$location, hits_df$hits)

climate_location_hits_table <- data.frame(climate_location_hits_table)

names(climate_location_hits_table)[1] <- "location"
names(climate_location_hits_table)[2] <- "hits"

#climate_location_hits_table
```

```{r}
#show(climate_trends)

n_states <- 10
top_states <- state_FEMA_decs_total[["state"]][1:n_states]

small_FEMA_table <- FEMA_Declarations %>% 
  subset(state %in% top_states) %>% 
  #filter(designated_area == "Statewide")
  

for (state in top_states) {
  
}

```


---
title: "Natural Disaster Sentiment Analysis"
author: "Scott Burstein"
date: "`r format(Sys.time(), '%d %B, %Y')`"
###"Data Science and Society (Sociology 367) - Final Project"
output: html_document
---

# Setup

## Configure RStudio Rmd File Output Format

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load the Libraries and Datasets

### Google Trends Package

[gtrendsR CRAN Package](https://cran.r-project.org/web/packages/gtrendsR/gtrendsR.pdf) 
used to perform and display Google Trends Queries.

Google Trends data is accessible in R through the gTrendsR package, which was 
created by [Philippe Masicotte](https://github.com/PMassicotte) and made 
available through [CRAN (The Comprehensive R Archive Network)](https://cran.r-project.org/).

Google trends data for specified search queries is represented by a `hits` variable, which expresses the relative volume of Google searches for specific 
terms over geographical and time parameters.

```{r load_packages, message = FALSE}
#---PACKAGES------  > remove "#" if package not previously installed
#install.packages("tidyverse")
library(tidyverse)
#install.packages("gtrendsR")
library(gtrendsR)
#install.packages("ggthemes")
library(ggthemes)
#install.packages("maps")
library(maps)
#install.packages("lubridate")
library(lubridate)
```

### README

See README for more thorough description of the `FEMA_Declarations` data set, 
with content summary, column variable descriptions, 
acknowledgments, source description and licensing information.

### Primary Data Source

[Kaggle Natural Disaster Data set](https://www.kaggle.com/headsortails/us-natural-disaster-declarations). The 
`FEMA_Declarations` data set is used for the bulk of this analysis and is also 
integrated with Google Trends data.

```{r load_data, message = FALSE}
#---DATA--------- > remove "#" to view raw data
FEMA_Declarations <- read_csv("FEMA_data/us_disaster_declarations.csv")
#view(FEMA_Declarations)
```
<br/><br/>

# Filter for Event Types

### Generalizable Parameters for Event Filter

In order to produce research that is both reproducible and timely, certain 
parameters can be initialized and instantiated once, and then referenced 
multiple times later. 
Since gTrendsR can easily return Google Trends information from the past five 
years, it is intuitive to create a `date_5y` variable that can be used to filter 
FEMA declarations by date, thus eliminating all those that occurred previously. 
The data set at large contains FEMA declarations from 1963 through the present.

```{r initialized_parameters, echo=FALSE}
# Start year to filter events (only show FEMA decs. since specified year)
date_5y <- Sys.Date() - 365.25*5

# Study 1:
#state1 <- 
#event_type1 <-

# Study 2:

```
The date this file was last compiled: 
Current date (`Sys.Date`) is  `r Sys.Date()`.

The date 5 years before, which is the starting time bound for subsequent Google 
Trends queries shown below: 
Variable `date_5y` is `r date_5y`.

```{r clean_date}
FEMA_Declarations <- FEMA_Declarations %>% 
  mutate(declaration_day = gsub( " .*$", "", declaration_date ))
```


## Florida Hurricanes since `r date_5y`

A list of all FEMA declarations for hurricanes in Florida occurring in the last 
5 years.

```{r FL_Hurricanes-events, echo=FALSE}
FL_Hurricanes <- FEMA_Declarations %>% 
  filter(incident_type == "Hurricane", incident_begin_date >= date_5y, state == "FL") %>% 
  select(declaration_title, declaration_day) %>% 
  distinct(declaration_title, .keep_all = TRUE)

FL_Hurricanes
```

```{r FL_Hurricanes-initialize}
num_days <- 14
State_Disaster <- FL_Hurricanes
```

```{r FL_Hurricanes-query}

events <- as.vector(State_Disaster$declaration_title)
dates <- as.vector(State_Disaster$declaration_day)

# initialize empty data frame
finaldata <- as.data.frame(NULL)
# for loop iterates over all events in events vector
for (i in 1:length(events)) {
  
  # create comb_time time boundaries for gtrends query
  start_date <- ymd(dates[i])
  end_date <- ymd(dates[i]) + num_days
  comb_time <- paste(start_date, end_date)

  # execute gtrends query for keyword = list_of_weather_events[i]
  event_trend <- gtrends(keyword = events[i],
                     geo = "US", time = comb_time)
  
  # weather_event_gtrends[1] object tracks interest_over_time
  all_time_interest <- as.data.frame(event_trend[1])
  finaldata <- rbind(finaldata, all_time_interest)
  print(i)
  Sys.sleep(5)
}

finaldata
```

```{r FL_Hurricanes-hits-df}
x <- finaldata %>%
  mutate(event_date = gsub( " .*$", "", interest_over_time.time ),
         hits_date = gsub( " .*$", "", interest_over_time.date )
         )
  
x <- x %>% 
  mutate(event_date = as.Date(event_date),
         hits_date = as.Date(hits_date),
         keyword = interest_over_time.keyword,
         hits = interest_over_time.hits) %>% 
  select(event_date, keyword, hits_date, hits) 

relative_date_mod <- x %>% 
  mutate(rel_date = hits_date - event_date)


hits_df <- relative_date_mod %>% 
  pivot_wider(names_from = rel_date, values_from = hits)

#n_vec <- as.vector(1:num_subsequent_days+1) 
#row_list <- list(df[i] for (i in n_vec))
coalesce_by_column <- function(df) {
  return(coalesce(df[1], df[2], df[3], df[4], df[5], df[6], df[7], df[8], df[9], 
                  df[10], df[11], df[12], df[13], df[14], df[15]))
}

hits_df %>%
  group_by(keyword) %>%
  summarise_all(coalesce_by_column)
```
`coalesce_by_column` function [description and source](https://stackoverflow.com/questions/45515218/combine-rows-in-data-frame-containing-na-to-make-complete-row)

## California Wildfires since `r date_5y`

A list of all FEMA declarations for wildfires in California occurring in the 
last 5 years.

```{r CA_Fires-events, echo=FALSE}
CA_Fires <- FEMA_Declarations %>% 
  filter(incident_type == "Fire", incident_begin_date >= date_5y, state == "CA") %>% 
  select(declaration_title, declaration_day) %>% 
  distinct(declaration_title, .keep_all = TRUE)
  
CA_Fires
```

```{r CA_Fires-initialize}
num_days <- 14
State_Disaster <- CA_Fires
```

```{r CA_Fires-query}

events <- as.vector(State_Disaster$declaration_title)
dates <- as.vector(State_Disaster$declaration_day)

# initialize empty data frame
finaldata <- as.data.frame(NULL)
# for loop iterates over all events in events vector
for (i in 1:length(events)) {
  
  # create comb_time time boundaries for gtrends query
  start_date <- ymd(dates[i])
  end_date <- ymd(dates[i]) + num_days
  comb_time <- paste(start_date, end_date)

  # execute gtrends query for keyword = list_of_weather_events[i]
  event_trend <- gtrends(keyword = events[i],
                     geo = "US", time = comb_time)
  
  # weather_event_gtrends[1] object tracks interest_over_time
  all_time_interest <- as.data.frame(event_trend[1])
  finaldata <- rbind(finaldata, all_time_interest)
  print(i)
  Sys.sleep(5)
}

finaldata
```

```{r CA_Fires-hits-df}
x <- finaldata %>%
  mutate(event_date = gsub( " .*$", "", interest_over_time.time ),
         hits_date = gsub( " .*$", "", interest_over_time.date )
         )
  
x <- x %>% 
  mutate(event_date = as.Date(event_date),
         hits_date = as.Date(hits_date),
         keyword = interest_over_time.keyword,
         hits = interest_over_time.hits) %>% 
  select(event_date, keyword, hits_date, hits) 

relative_date_mod <- x %>% 
  mutate(rel_date = hits_date - event_date)


hits_df <- relative_date_mod %>% 
  pivot_wider(names_from = rel_date, values_from = hits)

#n_vec <- as.vector(1:num_subsequent_days+1) 
#row_list <- list(df[i] for (i in n_vec))
coalesce_by_column <- function(df) {
  return(coalesce(df[1], df[2], df[3], df[4], df[5], df[6], df[7], df[8], df[9], 
                  df[10], df[11], df[12], df[13], df[14], df[15]))
}

hits_df %>%
  group_by(keyword) %>%
  summarise_all(coalesce_by_column)
```

# Research Questions

*1) Do Google search patterns correlate with real-world events?*


*2) Does interest in climate change increase regionally after the occurrence of 
a natural disaster?*


*3) Do people become more environmentally conscious, and modify their Google 
search behavior after a natural disaster?*

# Initial Analysis

```{r gtrends_function, echo=FALSE}

list_of_weather_events <- c("camp fire",
                            "hurricane")

finaldata <- as.data.frame(NULL)
for (i in 1:length(list_of_weather_events)) {
  weather_event_gtrends <- gtrends(keyword = list_of_weather_events[i],
                     geo = "US") #add date parameter time = "today 12-m" --> find date from original file of event. Use Lubridate
  all_states_interest <- as.data.frame(weather_event_gtrends[3])
  finaldata <- rbind(finaldata, all_states_interest)
  print(i)
  Sys.sleep(5)
}

#finaldata


climate_change_trend <- gtrends(keyword = "climate change",
                   geo = "US" #change location
                   ) 

#climate_change_trend[1]$interest_over_time
```

Visualizations, such as the faceted line plots below help illustrate important 
trends in sentiment towards climate change and associated topics. For example, 
interest in climate change, global warming, and the green new deal topics all 
spiked during the 2020 election season, as climate change became an important 
topic in the Presidential race.

```{r US_climate_change viz, echo=FALSE}

climate_search_terms <- c(
"climate change",		
"global warming",		
"fossil fuel",		
"green new deal"
)

climate_change_gtrends <- gtrends(keyword = climate_search_terms,
        geo = "US", #change to state?
        time = "today 12-m") 
#%>% summary()

climate_change_gtrends[1]$interest_over_time

US_climate_interest <- climate_change_gtrends %>% 
          .$interest_over_time %>% #not working
          glimpse()

 climate_change_facet_plot <- US_climate_interest %>% 
  mutate_at("hits", ~ifelse(. == "<1", 0.5, .)) %>% # replace with 0.5
  mutate_at("hits", ~as.numeric(.)) %>% # convert to numeric
  # Begin ggplot
  ggplot(aes(x = date, y = hits)) +
  #geom_vline(xintercept = 1.59e+09) + #determine key dates in correct format
  geom_line(colour = "darkblue", size = 1.5) +
  facet_wrap(~keyword) +
  ggthemes::theme_economist()
 #+ annotate()
climate_change_facet_plot
```
[Technical Resource Cited](https://martinctc.github.io/blog/vignette-google-trends-with-gtrendsr/)

```{r US_Hurricane_Interest, echo=FALSE}
search_terms <- c(
"Hurricane Michael",		
"Hurricane Dorian",		
"Hurricane Isaias",		
"Hurricane Sally"
)

output_results <- gtrends(keyword = search_terms,
        geo = "US", #change to FL
        time = "today 12-m") 
#%>% summary()

output_results[1]$interest_over_time


FL_hurr_interest <- output_results %>% 
          .$interest_over_time %>% #not working
          glimpse()
```

Another interesting property of Google Trends data is that in addition to 
tracking human sentiment towards longstanding topics, like climate change, it 
can also be used to detect one-time events, such as Hurricane Isaias and 
Hurricane Sally, two of the most devastating storms to hit the Gulf Coast and 
Southeastern United States in 2020. They were classified as Category 1 and 
Category 2 storms respectively, leaving more than $10.0 billion USD of damage in
their wakes.




Conversely, Hurricane Dorian from 2019 and Hurricane Michael from 2018 showed no 
more than ripples (hits â‰¤ 5) for the entirety of this past year. Interestingly 
though, search hits for these terms also increased during the 2020 hurricane 
season - around the time Google searches for active hurricanes spiked. It is 
reasonable to assume that people do become more interested in past natural 
disasters in order to contextualize the events that they are currently 
experiencing.

```{r FL_hurricane viz, echo=FALSE}
 FL_hurr_plot <- FL_hurr_interest %>% 
  mutate_at("hits", ~ifelse(. == "<1", 0.5, .)) %>% # replace with 0.5
  mutate_at("hits", ~as.numeric(.)) %>% # convert to numeric
  # Begin ggplot
  ggplot(aes(x = date, y = hits)) +
  geom_line(colour = "darkblue", size = 1.5) +
  facet_wrap(~keyword) +
  ggthemes::theme_economist()
FL_hurr_plot
```

```{r top_4_fires, echo=FALSE}
CA__top4_fires <- c(
"bobcat fire",		
"august fire",		
"creek fire",		
"bear fire"
)

CA_top_fire_trends <- gtrends(keyword = CA__top4_fires,
        geo = "US",
        time = "today 12-m") #%>% summary()


CA_fire_interest <- CA_top_fire_trends %>% 
          .$interest_over_time %>% 
          glimpse()

#CA_fire_interest[1]$interest_over_time
```

```{r CA_fire viz, echo=FALSE}
 CA_fire_facet_plot <- CA_fire_interest %>% 
  mutate_at("hits", ~ifelse(. == "<1", 0.5, .)) %>% # replace with 0.5
  mutate_at("hits", ~as.numeric(.)) %>% # convert to numeric
  # Begin ggplot
  ggplot(aes(x = date, y = hits)) +
  geom_line(colour = "dark red", size = 1.5) +
  facet_wrap(~keyword) +
  ggthemes::theme_economist()
CA_fire_facet_plot
```


```{r single_hit_yaxis_interest_plot, echo=FALSE}

fire_and_climate_change_search_terms <- c(
  "thomas fire",
  "august fire",
  "mendocino fire",
  "creek fire"
)

CA_all_fire_trends <- gtrends(keyword = fire_and_climate_change_search_terms,
        geo = "CA") #time = "today+5-y" Last five years (default)

CA_fire_plot <- plot.gtrends.silent(CA_all_fire_trends)
 
CA_fire_plot +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  theme(legend.position = "bottom")
```


```{r Generalizable plotting function, echo=FALSE}
plot.gtrends.silent <- function(x, ...) {
  df <- x$interest_over_time
  df$date <- as.Date(df$date)
  df$hits <- if(typeof(df$hits) == 'character'){
    as.numeric(gsub('<','',df$hits))
    } else {
    df$hits
    }
 
  df$legend <- paste(df$keyword, " (", df$geo, ")", sep = "")
 
  p <- ggplot(df, aes_string(x = "date", y = "hits", color = "legend")) +
    geom_line() +
    xlab("Date") +
    ylab("Search hits") +
    ggtitle("Interest over time") +
    theme_bw() +
    theme(legend.title = element_blank())
 
  invisible(p)
}
```
Methodology per Dave Tang, [Visualising Google Trends Results with R](https://davetang.org/muse/2018/12/31/visualising-google-trends-results-with-r/)


```{r single_hit_yaxis_interest_plot, echo=FALSE}

fire_and_climate_change_search_terms <- c(
  "fire",
  "climate change",
  "insurance"
)

CA_all_fire_trends <- gtrends(keyword = fire_and_climate_change_search_terms,
        geo = "CA") #time = "today+5-y" Last five years (default)

CA_fire_plot <- plot.gtrends.silent(CA_all_fire_trends)
 
CA_fire_plot +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  theme(legend.position = "bottom")
```
Methodology per Surbhi Tyagi, [Getting Google Trends Data Using gtrendsR](http://rstudio-pubs-static.s3.amazonaws.com/520533_f25fa191afa7476a995322a4393710ce.html)

```{r relative_yaxis_hit_plot, echo=FALSE}

indiv_fire_trend <- gtrends(keyword = "fire",
        geo = "CA") #time = "today+5-y" Last five years (default)

indiv_cc_trend <- gtrends(keyword = "climate change",
        geo = "CA") #time = "today+5-y" Last five years (default)

date <- data.frame(indiv_fire_trend[["interest_over_time"]][["date"]])
fire_hits <- data.frame(indiv_fire_trend[["interest_over_time"]][["hits"]])
cc_hits <- data.frame(indiv_cc_trend[["interest_over_time"]][["hits"]])

temp_fire_df <- cbind(date, fire_hits)
temp_cc_df <- cbind(date, cc_hits)

names(temp_fire_df)[1] <- "date"
names(temp_fire_df)[2] <- "fire_hits"

names(temp_cc_df)[1] <- "date"
names(temp_cc_df)[2] <- "cc_hits"

temp_joined <- inner_join(temp_fire_df, temp_cc_df, by = NULL) #def. by="date"
view(temp_joined)

graph_df <- temp_joined %>% 
  pivot_longer(!date, names_to = "type", values_to = "hits")

ggplot(data = graph_df) + 
  aes(x = date, y = hits, color = type) + 
  geom_line() + 
  scale_colour_viridis_d(option  = "viridis") + 
  labs(title = "Interest by Date", 
       x = "Date", 
       y = "Relative Interest") + 
  #scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  theme_minimal() + 
  theme(legend.position = 'bottom')
```

```{r state_date declaration count, echo=FALSE}
state_date_FEMA_decs <- FEMA_Declarations %>% 
  group_by(state, declaration_day) %>% 
  count()
```

```{r state declarations count since date, echo=FALSE}

state_FEMA_decs_total <- state_date_FEMA_decs %>%
  filter(declaration_day >= date_5y) %>% 
  group_by(state) %>% 
  count() %>% 
  arrange(desc(n))

state_FEMA_decs_total
```
Since `r date_5y` [as of 2020-11-19], the following 10 states have had the most FEMA 
natural disaster emergency declarations called:

CA, WA, OR, OK, FL, TX, NV, AZ, LA, MS

### Data set for climate change Google searches by day:

```{r climate_change_interest_by_state, echo=FALSE}
search_terms <- c(
"climate change"
)

climate_trends <- gtrends(keyword = search_terms,
        geo = "US", #change to FL
        time = "today 12-m")

location_df <- data.frame(climate_trends[["interest_by_region"]][["location"]])
hits_df <- data.frame(climate_trends[["interest_by_region"]][["hits"]])

names(location_df) <- "location"
names(hits_df) <- "hits"

climate_location_hits_table <- cbind(location_df$location, hits_df$hits)

climate_location_hits_table <- data.frame(climate_location_hits_table)

names(climate_location_hits_table)[1] <- "location"
names(climate_location_hits_table)[2] <- "hits"

#climate_location_hits_table
```

```{r top_states_function, echo=FALSE}
#show(climate_trends)

n_states <- 10
top_states <- state_FEMA_decs_total[["state"]][1:n_states]

date_5y <- Sys.Date() - 365.25*5

small_FEMA_table <- FEMA_Declarations %>% 
  subset(state %in% top_states) %>%
  mutate(incident_begin_day = gsub( " .*$", "", incident_begin_date ),
            incident_end_day = gsub( " .*$", "", incident_end_date ) ) %>% 
  filter(declaration_day >= date_5y) %>% 
  select(declaration_day, 
         state, 
         designated_area,
         declaration_type,
         incident_type, 
         declaration_title, 
         incident_begin_day, 
         incident_end_day
         )
small_FEMA_table
#%>% filter(designated_area == "Statewide")
  
  

for (state in top_states) {
  
}

```
# Bibliography

## Existing Scholarship on Climate Change Sentiment Analysis

1. CHOI, H. and VARIAN, H. (2012), Predicting the Present with Google Trends. 
Economic Record, 88: 2-9. https://doi.org/10.1111/j.1475-4932.2012.00809.x

2. "What do Google searches tell us about our climate change fears?" 
NewsRx Health & Science, 3 Aug. 2014, p. 177. Gale Academic OneFile, https://link.gale.com/apps/doc/A378494502/AONE?u=duke_perkins&sid=AONE&xid=7d6f5991. Accessed 16 Nov. 2020.

3. 

## Technical Sources for Programming & Visualizations

1. https://cran.r-project.org/web/packages/gtrendsR/gtrendsR.pdf

2. https://davetang.org/muse/2018/12/31/visualising-google-trends-results-with-r/

3. http://rstudio-pubs-static.s3.amazonaws.com/520533_f25fa191afa7476a995322a4393710ce.html

4. 
